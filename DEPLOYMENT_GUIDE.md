# üöÄ H∆∞·ªõng D·∫´n Deploy Shopify App L√™n Ubuntu Server

## üìã M·ª•c L·ª•c
1. [T·ªïng Quan H·ªá Th·ªëng](#t·ªïng-quan-h·ªá-th·ªëng)
2. [Y√™u C·∫ßu H·ªá Th·ªëng](#y√™u-c·∫ßu-h·ªá-th·ªëng)
3. [Chu·∫©n B·ªã Tr∆∞·ªõc Khi Deploy](#chu·∫©n-b·ªã-tr∆∞·ªõc-khi-deploy)
4. [C√†i ƒê·∫∑t Dependencies](#c√†i-ƒë·∫∑t-dependencies)
5. [C·∫•u H√¨nh Environment Variables](#c·∫•u-h√¨nh-environment-variables)
6. [Setup Database](#setup-database)
7. [Build Application](#build-application)
8. [Deploy v·ªõi Docker](#deploy-v·ªõi-docker)
9. [Deploy kh√¥ng d√πng Docker](#deploy-kh√¥ng-d√πng-docker)
10. [Testing](#testing)
11. [Monitoring v√† Logging](#monitoring-v√†-logging)
12. [Troubleshooting](#troubleshooting)
13. [Security Checklist](#security-checklist)

---

## üéØ T·ªïng Quan H·ªá Th·ªëng

### Tech Stack
- **Framework**: Remix (React-based)
- **Runtime**: Node.js v18.20+ ho·∫∑c v20+
- **Database**: MySQL 9.1.0
- **Cache/Queue**: Redis 8.0
- **Container**: Docker + Docker Compose
- **Package Manager**: npm
- **Shopify API**: @shopify/shopify-app-remix
- **ORM**: Prisma

### Ki·∫øn Tr√∫c
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Shopify Store  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Remix App     ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ    MySQL     ‚îÇ
‚îÇ  (Port 3000)    ‚îÇ      ‚îÇ  (Port 3306) ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ External API    ‚îÇ      ‚îÇ    Redis     ‚îÇ
‚îÇ  (Port 3001)    ‚îÇ      ‚îÇ  (Port 6379) ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### T√≠nh NƒÉng Ch√≠nh
1. **Product Management**: Qu·∫£n l√Ω s·∫£n ph·∫©m Shopify
2. **AI Image Generation**: T·∫°o ·∫£nh s·∫£n ph·∫©m b·∫±ng AI (6 styles)
3. **Product Optimization**: T·ªëi ∆∞u title, description, thumbnail
4. **Widget System**: Virtual Try-On widget
5. **Theme Extensions**: Shopify theme blocks

---

## üíª Y√™u C·∫ßu H·ªá Th·ªëng

### Server Requirements (Minimum)
- **OS**: Ubuntu 20.04 LTS ho·∫∑c m·ªõi h∆°n
- **RAM**: 4GB (khuy·∫øn ngh·ªã 8GB)
- **CPU**: 2 cores (khuy·∫øn ngh·ªã 4 cores)
- **Disk**: 20GB SSD
- **Network**: Public IP v·ªõi domain ƒë√£ setup SSL

### Software Requirements
```bash
# Node.js
node >= 18.20.0 ho·∫∑c >= 20.10.0

# Docker (n·∫øu d√πng Docker)
Docker >= 20.10.0
Docker Compose >= 2.0.0

# Database
MySQL >= 8.0 ho·∫∑c 9.1.0
Redis >= 6.0

# System Tools
git
curl
build-essential
```

---

## üîß Chu·∫©n B·ªã Tr∆∞·ªõc Khi Deploy

### 1. Clone Repository
```bash
# SSH v√†o server Ubuntu
ssh user@your-server-ip

# Clone project
git clone <repository-url> /var/www/easyd-2
cd /var/www/easyd-2
```

### 2. Ki·ªÉm Tra Node.js Version
```bash
node --version  # Ph·∫£i >= 18.20.0

# N·∫øu ch∆∞a c√≥ ho·∫∑c version c≈©, c√†i ƒë·∫∑t Node.js
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt-get install -y nodejs
```

### 3. C√†i ƒê·∫∑t Docker (N·∫øu Deploy b·∫±ng Docker)
```bash
# C√†i Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# C√†i Docker Compose
sudo apt-get install docker-compose-plugin

# Ki·ªÉm tra
docker --version
docker compose version

# Add user v√†o docker group (kh√¥ng c·∫ßn sudo)
sudo usermod -aG docker $USER
newgrp docker
```

---

## üì¶ C√†i ƒê·∫∑t Dependencies

### Install Node Modules
```bash
cd /var/www/easyd-2

# Install dependencies
npm ci --omit=dev

# N·∫øu development environment
npm install
```

**‚ö†Ô∏è QUAN TR·ªåNG**: Kh√¥ng commit `node_modules/`!

---

## üîê C·∫•u H√¨nh Environment Variables

### 1. T·∫°o File `.env` t·ª´ Template

```bash
# Copy file template
cp local.env .env

# Ho·∫∑c t·∫°o file m·ªõi
nano .env
```

### 2. N·ªôi Dung File `.env` Production

```bash
# ============================================
# DATABASE CONFIGURATION
# ============================================
# Format: mysql://USER:PASSWORD@HOST:PORT/DATABASE
DATABASE_URL=mysql://root:your_strong_password@localhost:3306/main

# ============================================
# REDIS CONFIGURATION
# ============================================
REDIS_HOST=localhost
REDIS_PORT=6379
# REDIS_PASSWORD=your_redis_password  # N·∫øu c√≥ set password

# ============================================
# NODE ENVIRONMENT
# ============================================
NODE_ENV=production

# ============================================
# SHOPIFY APP CONFIGURATION
# ============================================
# Get from: https://partners.shopify.com/
SHOPIFY_API_KEY=your_shopify_api_key_here
SHOPIFY_API_SECRET=your_shopify_api_secret_here
SHOPIFY_APP_ID=2ffd238e00074de340be24c6da5d6883

# Shopify App URL (your production domain)
SHOPIFY_APP_URL=https://your-domain.com

# Shopify Scopes
SCOPES=read_files,read_locales,read_markets,read_products,read_themes,write_files,write_products,write_themes

# Shopify Demo Theme Extension ID
SHOPIFY_DEMO_THEME_EXT_ID=903df1ac-205f-437f-810c-463263c95f58

# Shopify Webhook Secret
SHOPIFY_WEBHOOK_SECRET=your-webhook-secret-here

# Storefront Access Token
STOREFRONT_ACCESS_TOKEN=your_storefront_access_token_here

# ============================================
# AI API KEYS
# ============================================
# Gemini AI - Get from: https://aistudio.google.com/app/apikey
GEMINI_API_KEY=your_gemini_api_key_here

# OpenRouter API - Get from: https://openrouter.ai/keys
OPENROUTER_API_KEY=your_openrouter_api_key_here

# ============================================
# APPLICATION SETTINGS
# ============================================
SITE_URL=https://your-domain.com
SITE_NAME=Virtual Try-On App

# Port configuration
PORT=3000

# ============================================
# EXTERNAL API
# ============================================
# External API URL for image generation
# If running on same server: http://localhost:3001
# If running on different server: http://api-server-ip:3001
EXTERNAL_API_URL=http://localhost:3001

# ============================================
# OPTIONAL: DEVELOPMENT ONLY
# ============================================
# Suppress React warnings (remove in production)
# SUPPRESS_REACT_WARNINGS=true
```

### 3. File Permissions
```bash
# Set proper permissions cho .env
chmod 600 .env

# Ch·ªâ owner c√≥ th·ªÉ ƒë·ªçc/ghi
ls -la .env
# Output: -rw------- 1 user user 1234 Jan 01 00:00 .env
```

### 4. ‚ö†Ô∏è **C·ª∞C K·ª≤ QUAN TR·ªåNG: KH√îNG COMMIT C√ÅC FILE SAU**

**Th√™m v√†o `.gitignore` (ƒë√£ c√≥ s·∫µn nh∆∞ng ki·ªÉm tra l·∫°i):**

```bash
# Environment variables
.env
.env.local
.env.development.local
.env.test.local
.env.production.local
local.env

# Dependencies
node_modules/

# Build output
build/
dist/

# Logs
logs/
*.log

# Database
*.sqlite
*.db

# OS
.DS_Store
Thumbs.db

# IDE
.vscode/
.idea/
*.swp
*.swo

# Shopify CLI
.shopify/

# Prisma
prisma/generated/

# Cache
.cache/
.parcel-cache/
```

**Ki·ªÉm tra tr∆∞·ªõc khi commit:**
```bash
# Xem nh·ªØng file s·∫Ω ƒë∆∞·ª£c commit
git status

# N·∫øu th·∫•y .env ho·∫∑c node_modules, D·ª™NG NGAY!
# Remove kh·ªèi git n·∫øu ƒë√£ add nh·∫ßm
git rm --cached .env
git rm --cached -r node_modules/

# Commit .gitignore
git add .gitignore
git commit -m "chore: update gitignore to prevent sensitive files"
```

---

## üóÑÔ∏è Setup Database

### Option 1: Docker Compose (Khuy·∫øn ngh·ªã)

File `docker-compose.yml` ƒë√£ c√≥ s·∫µn:

```bash
# Start MySQL v√† Redis
docker compose up -d mysql redis

# Ki·ªÉm tra containers
docker compose ps

# Xem logs
docker compose logs -f mysql
```

**Database Credentials t·ª´ docker-compose.yml:**
- Host: `localhost`
- Port: `33063` (mapped from 3306)
- Database: `main`
- User: `root`
- Password: `root`

### Option 2: Manual MySQL Installation

```bash
# C√†i MySQL
sudo apt update
sudo apt install mysql-server

# Secure installation
sudo mysql_secure_installation

# Login v√†o MySQL
sudo mysql -u root -p

# T·∫°o database v√† user
CREATE DATABASE main CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'easyd_user'@'localhost' IDENTIFIED BY 'strong_password_here';
GRANT ALL PRIVILEGES ON main.* TO 'easyd_user'@'localhost';
FLUSH PRIVILEGES;
EXIT;
```

### Run Prisma Migrations

```bash
# Generate Prisma Client
npx prisma generate

# Run migrations ƒë·ªÉ t·∫°o tables
npx prisma migrate deploy

# Ki·ªÉm tra database
npx prisma studio
# M·ªü browser: http://localhost:5555
```

**Ki·ªÉm tra tables ƒë√£ t·∫°o:**
```bash
mysql -u root -p main -e "SHOW TABLES;"
```

Expected tables:
- Session
- User
- PricingModule
- PricingFeature
- PricingModuleFeature
- Subscription
- SubscriptionQuota
- UsageLog
- PaymentLog
- SourceProduct
- SourceCategory
- PlatformProduct
- ProductOptimizationSettings
- ProductsOptimized
- DropeaseProduct
- WidgetConfig

---

## üèóÔ∏è Build Application

### 1. Run Build
```bash
cd /var/www/easyd-2

# Production build
npm run build

# Ki·ªÉm tra build output
ls -la build/
```

Output structure:
```
build/
‚îú‚îÄ‚îÄ client/
‚îÇ   ‚îú‚îÄ‚îÄ assets/
‚îÇ   ‚îî‚îÄ‚îÄ index.html
‚îî‚îÄ‚îÄ server/
    ‚îî‚îÄ‚îÄ index.js
```

### 2. Test Build Locally
```bash
# Start production server
npm run start

# Ho·∫∑c
node build/server/index.js

# Test trong browser ho·∫∑c curl
curl http://localhost:3000
```

---

## üê≥ Deploy v·ªõi Docker

### 1. Build Docker Image

```bash
# Build image
docker build -t easyd-app:latest .

# Ki·ªÉm tra image
docker images | grep easyd-app
```

### 2. Docker Compose Full Stack

T·∫°o file `docker-compose.prod.yml`:

```yaml
version: "3.8"

services:
  # MySQL Database
  mysql:
    image: mysql:9.1.0
    container_name: easyd_mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
      MYSQL_DATABASE: main
      MYSQL_USER: easyd_user
      MYSQL_PASSWORD: ${DB_PASSWORD}
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
    networks:
      - easyd_network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis Cache
  redis:
    image: redis:8.0-M02
    container_name: easyd_redis
    restart: always
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - easyd_network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  # Remix App
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: easyd_app
    restart: always
    ports:
      - "3000:3000"
    environment:
      NODE_ENV: production
      DATABASE_URL: mysql://easyd_user:${DB_PASSWORD}@mysql:3306/main
      REDIS_HOST: redis
      REDIS_PORT: 6379
      SHOPIFY_API_KEY: ${SHOPIFY_API_KEY}
      SHOPIFY_API_SECRET: ${SHOPIFY_API_SECRET}
      SHOPIFY_APP_URL: ${SHOPIFY_APP_URL}
      GEMINI_API_KEY: ${GEMINI_API_KEY}
      OPENROUTER_API_KEY: ${OPENROUTER_API_KEY}
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - easyd_network
    volumes:
      - app_logs:/app/logs

networks:
  easyd_network:
    driver: bridge

volumes:
  mysql_data:
  redis_data:
  app_logs:
```

### 3. T·∫°o `.env.docker`

```bash
# Database
DB_ROOT_PASSWORD=strong_root_password_here
DB_PASSWORD=strong_user_password_here

# Shopify
SHOPIFY_API_KEY=your_key_here
SHOPIFY_API_SECRET=your_secret_here
SHOPIFY_APP_URL=https://your-domain.com

# AI APIs
GEMINI_API_KEY=your_gemini_key
OPENROUTER_API_KEY=your_openrouter_key
```

### 4. Deploy v·ªõi Docker Compose

```bash
# Start all services
docker compose -f docker-compose.prod.yml --env-file .env.docker up -d

# Xem logs
docker compose logs -f app

# Ki·ªÉm tra status
docker compose ps

# Stop services
docker compose down

# Stop v√† x√≥a volumes (‚ö†Ô∏è X√≥a data!)
docker compose down -v
```

---

## üîß Deploy Kh√¥ng D√πng Docker

### 1. Setup PM2 Process Manager

```bash
# Install PM2 globally
sudo npm install -g pm2

# Create PM2 ecosystem file
nano ecosystem.config.js
```

**`ecosystem.config.js`:**
```javascript
module.exports = {
  apps: [{
    name: 'easyd-app',
    script: './build/server/index.js',
    instances: 2,
    exec_mode: 'cluster',
    watch: false,
    max_memory_restart: '1G',
    env_production: {
      NODE_ENV: 'production',
      PORT: 3000
    },
    error_file: './logs/pm2-error.log',
    out_file: './logs/pm2-out.log',
    log_date_format: 'YYYY-MM-DD HH:mm:ss Z',
    merge_logs: true
  }]
};
```

### 2. Start Application v·ªõi PM2

```bash
# Create logs directory
mkdir -p logs

# Start app
pm2 start ecosystem.config.js --env production

# Save PM2 configuration
pm2 save

# Setup PM2 startup script (auto-start on server reboot)
pm2 startup systemd
# Copy v√† run command ƒë∆∞·ª£c output

# Ki·ªÉm tra status
pm2 status
pm2 logs easyd-app

# Monitoring
pm2 monit
```

### 3. Setup Nginx Reverse Proxy

```bash
# Install Nginx
sudo apt update
sudo apt install nginx

# Create Nginx config
sudo nano /etc/nginx/sites-available/easyd-app
```

**Nginx Configuration:**
```nginx
upstream easyd_backend {
    server localhost:3000;
    keepalive 64;
}

server {
    listen 80;
    server_name your-domain.com;

    # Redirect HTTP to HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com;

    # SSL Configuration (use Certbot)
    ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;
    
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    # Logging
    access_log /var/log/nginx/easyd-app-access.log;
    error_log /var/log/nginx/easyd-app-error.log;

    # Security Headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # Max upload size (for product images)
    client_max_body_size 50M;

    # Proxy to Node.js app
    location / {
        proxy_pass http://easyd_backend;
        proxy_http_version 1.1;
        
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;
    }

    # Static assets caching
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        proxy_pass http://easyd_backend;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
```

```bash
# Enable site
sudo ln -s /etc/nginx/sites-available/easyd-app /etc/nginx/sites-enabled/

# Test config
sudo nginx -t

# Reload Nginx
sudo systemctl reload nginx
```

### 4. Setup SSL v·ªõi Let's Encrypt

```bash
# Install Certbot
sudo apt install certbot python3-certbot-nginx

# Get SSL certificate
sudo certbot --nginx -d your-domain.com

# Auto-renewal is setup automatically
# Test renewal
sudo certbot renew --dry-run
```

---

## üß™ Testing

### 1. Health Check Endpoints

```bash
# Check app is running
curl http://localhost:3000

# Check database connection
curl http://localhost:3000/api/health/database

# Check Redis connection
curl http://localhost:3000/api/health/redis
```

### 2. Test Shopify Integration

```bash
# Test OAuth flow
curl https://your-domain.com/api/auth?shop=test-store.myshopify.com

# Test product API (need auth token)
curl -H "Authorization: Bearer YOUR_TOKEN" \
  https://your-domain.com/api/products
```

### 3. Test AI Image Generation

```bash
# Test generate-image endpoint
curl -X POST https://your-domain.com/api/generate-image \
  -H "Content-Type: application/json" \
  -d '{
    "productTitle": "Test Product",
    "productImages": ["https://example.com/image.jpg"],
    "language": "en",
    "market": "us"
  }'
```

### 4. Load Testing v·ªõi Apache Bench

```bash
# Install Apache Bench
sudo apt install apache2-utils

# Test 1000 requests, 10 concurrent
ab -n 1000 -c 10 https://your-domain.com/

# View results
```

---

## üìä Monitoring v√† Logging

### 1. PM2 Monitoring

```bash
# Real-time monitoring
pm2 monit

# View logs
pm2 logs easyd-app --lines 100

# Flush logs
pm2 flush
```

### 2. Database Monitoring

```bash
# MySQL slow query log
sudo nano /etc/mysql/mysql.conf.d/mysqld.cnf

# Add:
slow_query_log = 1
slow_query_log_file = /var/log/mysql/slow-query.log
long_query_time = 2

# Restart MySQL
sudo systemctl restart mysql

# View slow queries
sudo tail -f /var/log/mysql/slow-query.log
```

### 3. Redis Monitoring

```bash
# Connect to Redis
redis-cli

# Monitor commands
MONITOR

# Get stats
INFO stats

# Check memory
INFO memory
```

### 4. Setup Log Rotation

```bash
# Create logrotate config
sudo nano /etc/logrotate.d/easyd-app
```

```
/var/www/easyd-2/logs/*.log {
    daily
    rotate 14
    compress
    delaycompress
    notifempty
    create 0640 www-data www-data
    sharedscripts
    postrotate
        pm2 reloadLogs
    endscript
}
```

### 5. Setup Monitoring v·ªõi UptimeRobot

1. ƒêƒÉng k√Ω account t·∫°i: https://uptimerobot.com
2. Add monitor cho domain: `https://your-domain.com`
3. Setup email alerts

---

## üîç Troubleshooting

### Issue 1: App kh√¥ng start

**Tri·ªáu ch·ª©ng:**
```bash
Error: Cannot find module 'build/server/index.js'
```

**Gi·∫£i ph√°p:**
```bash
# Re-build app
npm run build

# Check build output
ls -la build/server/

# Check Node version
node --version  # Ph·∫£i >= 18.20.0
```

### Issue 2: Database connection failed

**Tri·ªáu ch·ª©ng:**
```bash
PrismaClientInitializationError: Can't reach database server
```

**Gi·∫£i ph√°p:**
```bash
# Check MySQL is running
sudo systemctl status mysql

# Check connection
mysql -h localhost -P 3306 -u root -p

# Test DATABASE_URL
npx prisma db pull

# Check firewall
sudo ufw status
```

### Issue 3: Redis connection failed

**Tri·ªáu ch·ª©ng:**
```bash
Error: Redis connection to localhost:6379 failed
```

**Gi·∫£i ph√°p:**
```bash
# Check Redis is running
redis-cli ping
# Should return: PONG

# Check Redis logs
sudo tail -f /var/log/redis/redis-server.log

# Restart Redis
sudo systemctl restart redis
```

### Issue 4: External API kh√¥ng respond

**Tri·ªáu ch·ª©ng:**
```
External API server at http://localhost:3001 is not responding correctly
```

**Gi·∫£i ph√°p:**
```bash
# Check if external API server is running
curl http://localhost:3001/health

# Start external API server n·∫øu ch∆∞a c√≥
# (C·∫ßn c√≥ document ri√™ng cho External API setup)

# Update API_BASE_URL trong /app/routes/api.generate-image.jsx
# Ho·∫∑c set environment variable
EXTERNAL_API_URL=http://correct-api-server:3001
```

### Issue 5: Shopify OAuth failed

**Tri·ªáu ch·ªØng:**
```
Error: Invalid HMAC signature
```

**Gi·∫£i ph√°p:**
```bash
# Check Shopify credentials trong .env
cat .env | grep SHOPIFY

# Verify v·ªõi Shopify Partners Dashboard
# https://partners.shopify.com/

# Check redirect URLs match
# Update shopify.app.toml n·∫øu c·∫ßn

# Re-deploy v·ªõi Shopify CLI
npm run deploy
```

### Issue 6: Build errors

**Tri·ªáu ch·ª©ng:**
```bash
npm ERR! Failed at the easydrop@1.0.0 build script
```

**Gi·∫£i ph√°p:**
```bash
# Clean install
rm -rf node_modules package-lock.json
npm install

# Check for missing dependencies
npm audit fix

# Build again
npm run build
```

### Issue 7: PM2 app crashed

**Tri·ªáu ch·ª©ng:**
```bash
pm2 status
# Shows: status: errored
```

**Gi·∫£i ph√°p:**
```bash
# View error logs
pm2 logs easyd-app --err --lines 50

# Delete v√† restart
pm2 delete easyd-app
pm2 start ecosystem.config.js --env production

# Increase memory limit n·∫øu c·∫ßn
# Edit ecosystem.config.js:
# max_memory_restart: '2G'
```

---

## üîí Security Checklist

### ‚úÖ Before Going to Production

- [ ] **Environment Variables**
  - [ ] All API keys are in `.env`, NOT in code
  - [ ] `.env` is in `.gitignore`
  - [ ] `.env` file permissions: `chmod 600`
  - [ ] No sensitive data in git history

- [ ] **Database Security**
  - [ ] MySQL root password changed from default
  - [ ] Database user has minimum required privileges
  - [ ] MySQL port kh√¥ng expose ra internet (bind to localhost)
  - [ ] Regular backups configured

- [ ] **Redis Security**
  - [ ] Redis c√≥ password (n·∫øu expose)
  - [ ] Redis bind to localhost only
  - [ ] Disable dangerous commands: `rename-command CONFIG ""`

- [ ] **Application Security**
  - [ ] All dependencies updated: `npm audit fix`
  - [ ] NODE_ENV=production
  - [ ] Rate limiting configured
  - [ ] CORS properly configured
  - [ ] CSP headers configured

- [ ] **Server Security**
  - [ ] UFW firewall enabled
  - [ ] Only ports 80, 443, 22 open to public
  - [ ] SSH key-based authentication
  - [ ] Fail2ban installed
  - [ ] Automatic security updates enabled

- [ ] **SSL/TLS**
  - [ ] SSL certificate installed
  - [ ] HTTPS redirect configured
  - [ ] HSTS header enabled
  - [ ] TLS 1.2+ only

- [ ] **Monitoring**
  - [ ] Uptime monitoring setup
  - [ ] Error logging configured
  - [ ] Disk space alerts
  - [ ] Email notifications for critical errors

### UFW Firewall Setup

```bash
# Enable UFW
sudo ufw enable

# Allow SSH (‚ö†Ô∏è DO THIS FIRST!)
sudo ufw allow 22/tcp

# Allow HTTP v√† HTTPS
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# Check status
sudo ufw status verbose

# Default policies
sudo ufw default deny incoming
sudo ufw default allow outgoing
```

### Database Backup Script

```bash
# Create backup script
sudo nano /usr/local/bin/backup-easyd-db.sh
```

```bash
#!/bin/bash
BACKUP_DIR="/var/backups/easyd-db"
DATE=$(date +%Y%m%d_%H%M%S)
DB_NAME="main"
DB_USER="root"
DB_PASS="your_password"

mkdir -p $BACKUP_DIR

# Backup database
mysqldump -u $DB_USER -p$DB_PASS $DB_NAME | gzip > $BACKUP_DIR/backup_$DATE.sql.gz

# Keep only last 7 days backups
find $BACKUP_DIR -name "backup_*.sql.gz" -mtime +7 -delete

echo "Backup completed: backup_$DATE.sql.gz"
```

```bash
# Make executable
sudo chmod +x /usr/local/bin/backup-easyd-db.sh

# Setup cron job (daily at 2 AM)
sudo crontab -e

# Add:
0 2 * * * /usr/local/bin/backup-easyd-db.sh >> /var/log/easyd-backup.log 2>&1
```

---

## üìù Deployment Checklist

### Pre-Deployment

- [ ] Code ƒë√£ test k·ªπ tr√™n local
- [ ] All tests passed
- [ ] Database migrations tested
- [ ] `.env.example` updated v·ªõi t·∫•t c·∫£ required variables
- [ ] Documentation updated
- [ ] Backup database production (n·∫øu c√≥)

### Deployment Steps

- [ ] Pull latest code: `git pull origin main`
- [ ] Install dependencies: `npm ci --omit=dev`
- [ ] Run migrations: `npx prisma migrate deploy`
- [ ] Build app: `npm run build`
- [ ] Restart app: `pm2 restart easyd-app` ho·∫∑c `docker compose restart`
- [ ] Check logs: `pm2 logs` ho·∫∑c `docker compose logs -f`
- [ ] Test endpoints
- [ ] Monitor for 15 minutes

### Post-Deployment

- [ ] Verify all features working
- [ ] Check error logs
- [ ] Monitor performance metrics
- [ ] Notify team deployment completed
- [ ] Document any issues encountered

---

## üÜò Emergency Procedures

### Rollback

```bash
# If deployment failed, rollback immediately

# 1. Switch to previous git commit
git log --oneline -5
git checkout <previous-commit-hash>

# 2. Rebuild
npm run build

# 3. Restart
pm2 restart easyd-app

# 4. Rollback database n·∫øu c·∫ßn
npx prisma migrate resolve --rolled-back <migration-name>
```

### Emergency Contacts

- **Dev Team Lead**: [contact info]
- **DevOps**: [contact info]
- **On-call Engineer**: [contact info]

---

## üìö Additional Resources

- [Shopify App Development Docs](https://shopify.dev/docs/apps)
- [Remix Documentation](https://remix.run/docs)
- [Prisma Documentation](https://www.prisma.io/docs)
- [PM2 Documentation](https://pm2.keymetrics.io/docs)
- [Docker Documentation](https://docs.docker.com)
- [Nginx Documentation](https://nginx.org/en/docs/)

---

## üîÑ Maintenance

### Weekly Tasks
- [ ] Check disk space: `df -h`
- [ ] Check memory usage: `free -h`
- [ ] Review error logs
- [ ] Check database size: `du -sh /var/lib/mysql/main`

### Monthly Tasks
- [ ] Update dependencies: `npm update`
- [ ] Review security advisories: `npm audit`
- [ ] Check SSL certificate expiry
- [ ] Review and rotate logs
- [ ] Database optimization: `OPTIMIZE TABLE`

### Quarterly Tasks
- [ ] Full security audit
- [ ] Performance testing
- [ ] Disaster recovery test
- [ ] Documentation review

---

## üìß Support

N·∫øu g·∫∑p v·∫•n ƒë·ªÅ trong qu√° tr√¨nh deploy:

1. Check troubleshooting section tr∆∞·ªõc
2. Review logs chi ti·∫øt
3. Search similar issues trong project issues/docs
4. Contact team lead v·ªõi ƒë·∫ßy ƒë·ªß th√¥ng tin:
   - Error logs
   - Steps to reproduce
   - Environment details (OS, Node version, etc.)
   - Screenshot n·∫øu c√≥

---

**Document Version**: 1.0.0  
**Last Updated**: 2025-01-28  
**Maintained By**: Development Team  
**Review Cycle**: Monthly

---

## ‚ö†Ô∏è CRITICAL REMINDERS

1. **KH√îNG BAO GI·ªú commit `.env` file!**
2. **LU√îN backup database tr∆∞·ªõc khi migrate!**
3. **Test migrations tr√™n staging tr∆∞·ªõc!**
4. **Monitor logs sau m·ªói deployment!**
5. **Keep API keys SECRET v√† rotate th∆∞·ªùng xuy√™n!**

---

## üéâ Deployment Complete!

Sau khi follow h·∫øt c√°c b∆∞·ªõc tr√™n, application c·ªßa b·∫°n ƒë√£ s·∫µn s√†ng cho production!

**Next Steps:**
1. Setup monitoring v√† alerts
2. Configure CDN n·∫øu c·∫ßn (Cloudflare, AWS CloudFront)
3. Setup CI/CD pipeline (GitHub Actions, GitLab CI)
4. Load testing v√† performance optimization
5. Setup staging environment cho testing

**Happy Deploying! üöÄ**


