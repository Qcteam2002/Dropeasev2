{% if request.page_type == 'product' %}
  {% assign sticky_bar_config = shop.metafields.custom.sticky_bar_config %}
  {% assign float_video_settings = shop.metafields.floatvideo.configuration.value | json %}
  {% assign video_url = product.metafields.floatvideo.configuration.value | json %}

  {% if sticky_bar_config %}
    {% assign sticky_settings = sticky_bar_config | json %}
    {% assign has_sticky_bar = sticky_settings.isActive %}
    
    <div id="sticky-bar" style="display: none;">
      <div class="sticky-content">
        <div class="product-info">
          <img id="sticky-product-image" class="product-image" src="" alt="Product image" width="100" height="100">
          <div class="product-details">
            <div class="product-title"></div>
            <div id="variant-name" class="variant-info">Select Variant</div>
          </div>
        </div>
        <select id="sticky-variant-selector"></select>
        <div class="quantity-selector">
          <button class="quantity-btn minus" onclick="updateQuantity('decrease')">-</button>
          <input type="number" id="sticky-quantity" value="1" min="1" onchange="validateQuantity(this)">
          <button class="quantity-btn plus" onclick="updateQuantity('increase')">+</button>
        </div>
        <div class="button-group">
          <button class="add-to-cart-btn" onclick="addToCartSticky()">
            <span class="atc-spinner" style="display: none;">
              <svg style="width: 20px; height: 20px;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none">
                <circle style="opacity: 0.25;" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path style="opacity: 0.75;" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
            </span>
            <span class="atc-text">Add to cart</span>
          </button>
          <button class="buy-now-btn" onclick="buyNowSticky()">Buy now</button>
        </div>
      </div>
    </div>

    <style>
      #sticky-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background: {{ sticky_settings.backgroundColor | default: '#ffffff' }};
        color: {{ sticky_settings.textColor | default: '#000000' }};
        padding: 10px 20px;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        z-index: 2147483647 !important;
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: {{ sticky_settings.titleFontFamily | default: 'sans-serif' }};
        height: {{ sticky_settings.barHeight | default: 60 }}px;
      }
      #sticky-bar .sticky-content {
        max-width: 1200px;
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 20px;
      }
      #sticky-bar .product-info {
        display: flex;
        align-items: center;
        gap: 15px;
      }
      #sticky-bar .product-image {
        width: 50px;
        height: 50px;
        object-fit: cover;
        border-radius: 4px;
      }
      #sticky-bar .product-details {
        display: flex;
        flex-direction: column;
      }
      #sticky-bar .product-title {
        font-size: {{ sticky_settings.titleFontSize | default: 14 }}px;
        font-weight: 600;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 300px;
      }
      #sticky-bar select {
        padding: 8px;
        border-radius: 4px;
        border: 1px solid #ccc;
        font-size: {{ sticky_settings.variantFontSize | default: 12 }}px;
        width: 160px;
        background: {{ sticky_settings.backgroundColor | default: '#ffffff' }};
        color: {{ sticky_settings.textColor | default: '#000000' }};
      }
      #sticky-bar .quantity-selector {
        display: flex;
        align-items: center;
        gap: 5px;
      }
      #sticky-bar .quantity-btn {
        width: 30px;
        height: 30px;
        border: 1px solid #ccc;
        background: {{ sticky_settings.backgroundColor | default: '#ffffff' }};
        color: {{ sticky_settings.textColor | default: '#000000' }};
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      #sticky-bar #sticky-quantity {
        width: 50px;
        height: 30px;
        text-align: center;
        border: 1px solid #ccc;
        border-radius: 4px;
        background: {{ sticky_settings.backgroundColor | default: '#ffffff' }};
        color: {{ sticky_settings.textColor | default: '#000000' }};
      }
      #sticky-bar .button-group {
        display: flex;
        gap: 10px;
      }
      #sticky-bar .add-to-cart-btn, #sticky-bar .buy-now-btn {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 5px;
      }
      #sticky-bar .add-to-cart-btn {
        background: {{ sticky_settings.addToCartColor | default: '#007bff' }};
        color: white;
      }
      #sticky-bar .buy-now-btn {
        background: {{ sticky_settings.buyNowColor | default: '#28a745' }};
        color: white;
      }
      @media (max-width: 768px) {
        #sticky-bar .sticky-content {
          flex-direction: column;
          gap: 10px;
        }
        #sticky-bar .product-title {
          max-width: 200px;
        }
        #sticky-bar select {
          width: 120px;
        }
      }
    </style>

    <script>
      let currentProduct = null;
      let currentVariant = null;
      let quantity = 1;

      function updateQuantity(action) {
        if (action === 'increase') {
          quantity++;
        } else if (action === 'decrease' && quantity > 1) {
          quantity--;
        }
        document.getElementById('sticky-quantity').value = quantity;
      }

      function validateQuantity(input) {
        const value = parseInt(input.value);
        if (value < 1) {
          input.value = 1;
          quantity = 1;
        } else {
          quantity = value;
        }
      }

      function addToCartSticky() {
        if (!currentVariant) return;
        
        const btn = document.querySelector('.add-to-cart-btn');
        const spinner = btn.querySelector('.atc-spinner');
        const text = btn.querySelector('.atc-text');
        
        spinner.style.display = 'inline-block';
        text.textContent = 'Adding...';
        btn.disabled = true;

        fetch('/cart/add.js', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            id: currentVariant.id,
            quantity: quantity
          })
        })
        .then(response => response.json())
        .then(data => {
          spinner.style.display = 'none';
          text.textContent = 'Added!';
          setTimeout(() => {
            text.textContent = 'Add to cart';
            btn.disabled = false;
          }, 1000);
        })
        .catch(error => {
          spinner.style.display = 'none';
          text.textContent = 'Error';
          setTimeout(() => {
            text.textContent = 'Add to cart';
            btn.disabled = false;
          }, 1000);
        });
      }

      function buyNowSticky() {
        if (!currentVariant) return;
        addToCartSticky();
        setTimeout(() => {
          window.location.href = '/cart';
        }, 1000);
      }

      function updateStickyBar() {
        if (!currentProduct) return;
        
        const stickyBar = document.getElementById('sticky-bar');
        const productImage = document.getElementById('sticky-product-image');
        const productTitle = document.querySelector('.product-title');
        const variantName = document.getElementById('variant-name');
        const variantSelector = document.getElementById('sticky-variant-selector');
        
        productImage.src = currentProduct.featured_image;
        productTitle.textContent = currentProduct.title;
        
        if (currentVariant) {
          variantName.textContent = currentVariant.title;
        }
        
        variantSelector.innerHTML = '';
        currentProduct.variants.forEach(variant => {
          const option = document.createElement('option');
          option.value = variant.id;
          option.textContent = variant.title;
          if (variant.id === currentVariant?.id) {
            option.selected = true;
          }
          variantSelector.appendChild(option);
        });
        
        variantSelector.addEventListener('change', (e) => {
          const selectedVariant = currentProduct.variants.find(v => v.id == e.target.value);
          if (selectedVariant) {
            currentVariant = selectedVariant;
            variantName.textContent = selectedVariant.title;
          }
        });
        
        stickyBar.style.display = 'flex';
      }

      document.addEventListener('DOMContentLoaded', function() {
        const productData = window.productData || window.meta.product;
        if (productData) {
          currentProduct = productData;
          currentVariant = productData.selected_or_first_available_variant;
          updateStickyBar();
        }
      });
    </script>
  {% endif %}

  {% if float_video_settings and float_video_settings.isActive and video_url %}
    <div id="floating-video" style="position: fixed; bottom: 20px; right: 20px; width: 300px; height: 200px; z-index: 1000; background: white; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); overflow: hidden;">
      <div style="position: relative; width: 100%; height: 100%;">
        <video 
          style="width: 100%; height: 100%; object-fit: cover;" 
          autoplay 
          muted 
          loop 
          playsinline
        >
          <source src="{{ video_url }}" type="video/mp4">
        </video>
        <button 
          onclick="document.getElementById('floating-video').style.display='none'" 
          style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 16px;"
        >
          ×
        </button>
      </div>
    </div>
  {% endif %}
{% endif %}

{% schema %}
{
  "name": "Floating Video Block",
  "target": "section",
  "settings": [
    {
      "type": "product",
      "id": "product",
      "label": "Select Product"
    }
  ]
}
{% endschema %}